<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR - Forest Sound</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- AR.js with fallback CDN -->
    <script>
        // è¼‰å…¥ AR.jsï¼Œå¸¶å‚™ç”¨ CDN
        function loadARjs() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/ar.js@2.2.2/aframe/build/aframe-ar.js';
                script.onload = () => {
                    console.log('AR.js loaded from primary CDN');
                    resolve();
                };
                script.onerror = () => {
                    console.warn('Primary CDN failed, trying fallback...');
                    // å‚™ç”¨ CDN
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = 'https://raw.githack.com/AR-js-org/AR.js/2.2.2/aframe/build/aframe-ar.js';
                    fallbackScript.onload = () => {
                        console.log('AR.js loaded from fallback CDN');
                        resolve();
                    };
                    fallbackScript.onerror = () => {
                        console.error('All CDNs failed');
                        reject(new Error('AR.js failed to load'));
                    };
                    document.head.appendChild(fallbackScript);
                };
                document.head.appendChild(script);
            });
        }
        
        // ç­‰å¾… A-Frame è¼‰å…¥å¾Œå†è¼‰å…¥ AR.js
        window.addEventListener('load', async function() {
            if (typeof AFRAME === 'undefined') {
                console.error('A-Frame failed to load!');
                return;
            }
            console.log('A-Frame loaded, loading AR.js...');
            try {
                await loadARjs();
                // ç­‰å¾… AR.js è¨»å†Šçµ„ä»¶
                setTimeout(() => {
                    if (AFRAME.components && AFRAME.components.arjs) {
                        console.log('AR.js component registered successfully');
                    } else {
                        console.warn('AR.js component not found, but script loaded');
                    }
                }, 500);
            } catch (error) {
                console.error('Failed to load AR.js:', error);
                const errorStatus = document.getElementById('errorStatus');
                if (errorStatus) {
                    errorStatus.innerHTML = 'âš ï¸ AR.js è¼‰å…¥å¤±æ•—<br>è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥';
                    errorStatus.classList.add('show');
                }
            }
        });
    </script>
    
    <!-- Tone.js -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #startOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }
        
        #startButton {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #startButton:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }
        
        #startButton:active {
            transform: scale(0.98);
        }
        
        .hidden {
            display: none !important;
        }
        
        a-scene {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }
        
        #loadingStatus {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 999;
            display: none;
        }
        
        #loadingStatus.show {
            display: block;
        }
        
        #errorStatus {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 999;
            display: none;
            max-width: 90%;
            text-align: center;
            line-height: 1.5;
        }
        
        #errorStatus.show {
            display: block;
        }
        
        #scanStatus {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            font-size: 16px;
            z-index: 998;
            display: none;
            text-align: center;
            min-width: 200px;
        }
        
        #scanStatus.show {
            display: block;
        }
        
        #scanStatus.scanning {
            background: rgba(33, 150, 243, 0.8);
            animation: pulse 2s infinite;
        }
        
        #scanStatus.detected {
            background: rgba(76, 175, 80, 0.9);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        /* AR.js èª¿è©¦ä¿¡æ¯æ¨£å¼ */
        .arjs-debug {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            z-index: 1000 !important;
            background: rgba(0, 0, 0, 0.7) !important;
            color: white !important;
            padding: 10px !important;
            font-size: 12px !important;
            border-radius: 5px !important;
        }
        
        /* è‡ªå®šç¾©èª¿è©¦ä¿¡æ¯ */
        #debugInfo {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            font-size: 11px;
            font-family: monospace;
            z-index: 1001;
            border-radius: 5px;
            max-width: 300px;
            line-height: 1.4;
            display: none;
        }
        
        #debugInfo.show {
            display: block;
        }
        
        #debugInfo .error {
            color: #f00;
        }
        
        #debugInfo .success {
            color: #0f0;
        }
        
        #debugInfo .warning {
            color: #ff0;
        }
        
        /* ä½¿ç”¨èªªæ˜ */
        #instructions {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 13px;
            z-index: 997;
            display: none;
            max-width: 90%;
            text-align: center;
            line-height: 1.6;
        }
        
        #instructions.show {
            display: block;
        }
        
        #instructions strong {
            color: #4CAF50;
        }
        
        /* æƒææ¡† */
        #scanFrame {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid #4CAF50;
            border-radius: 10px;
            z-index: 995;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5),
                        0 0 20px rgba(76, 175, 80, 0.8);
            display: none;
            animation: scanPulse 2s infinite;
        }
        
        #scanFrame.show {
            display: block;
        }
        
        #scanFrame.detecting {
            border-color: #2196F3;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5),
                        0 0 20px rgba(33, 150, 243, 0.8);
            animation: scanPulse 1s infinite;
        }
        
        #scanFrame.detected {
            border-color: #4CAF50;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3),
                        0 0 30px rgba(76, 175, 80, 1);
            animation: scanSuccess 0.5s;
        }
        
        @keyframes scanPulse {
            0%, 100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 0.7;
                transform: translate(-50%, -50%) scale(1.05);
            }
        }
        
        @keyframes scanSuccess {
            0% {
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* æƒææ¡†å››å€‹è§’çš„è£é£¾ */
        #scanFrame::before,
        #scanFrame::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #4CAF50;
        }
        
        #scanFrame::before {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 10px;
        }
        
        #scanFrame::after {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 10px;
        }
        
        #scanFrame .corner-top-right,
        #scanFrame .corner-bottom-left {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #4CAF50;
        }
        
        #scanFrame .corner-top-right {
            top: -4px;
            right: -4px;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 10px;
        }
        
        #scanFrame .corner-bottom-left {
            bottom: -4px;
            left: -4px;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 10px;
        }
        
        /* æª¢æ¸¬ç‹€æ…‹æ™‚æ”¹è®Šè§’çš„é¡è‰² */
        #scanFrame.detecting::before,
        #scanFrame.detecting::after,
        #scanFrame.detecting .corner-top-right,
        #scanFrame.detecting .corner-bottom-left {
            border-color: #2196F3;
        }
        
        #scanFrame.detected::before,
        #scanFrame.detected::after,
        #scanFrame.detected .corner-top-right,
        #scanFrame.detected .corner-bottom-left {
            border-color: #4CAF50;
        }
        
        /* å°æº–æç¤ºæ–‡å­— */
        #alignHint {
            position: fixed;
            top: calc(50% + 140px);
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 16px;
            text-align: center;
            z-index: 996;
            display: none;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        #alignHint.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- é–‹å§‹é®ç½©å±¤ -->
    <div id="startOverlay">
        <button id="startButton">é»æ“Šé–‹å§‹</button>
    </div>
    
    <!-- è¼‰å…¥ç‹€æ…‹æŒ‡ç¤º -->
    <div id="loadingStatus">æ­£åœ¨åˆå§‹åŒ– AR...</div>
    
    <!-- éŒ¯èª¤ç‹€æ…‹æŒ‡ç¤º -->
    <div id="errorStatus"></div>
    
    <!-- æƒæç‹€æ…‹æŒ‡ç¤º -->
    <div id="scanStatus">æ­£åœ¨æƒæ Marker...</div>
    
    <!-- ä½¿ç”¨èªªæ˜ -->
    <div id="instructions">
        <strong>ğŸ“± ä½¿ç”¨æç¤ºï¼š</strong><br>
        1. ç¢ºä¿å…‰ç·šå……è¶³<br>
        2. å°‡ Marker å®Œæ•´é¡¯ç¤ºåœ¨ç•«é¢ä¸­<br>
        3. ä¿æŒæ‰‹æ©Ÿç©©å®šï¼Œè·é›¢ç´„ 20-30 å…¬åˆ†<br>
        4. å·¦ä¸Šè§’æœƒé¡¯ç¤ºæª¢æ¸¬ç‹€æ…‹
    </div>
    
    <!-- æƒææ¡† -->
    <div id="scanFrame">
        <div class="corner-top-right"></div>
        <div class="corner-bottom-left"></div>
    </div>
    
    <!-- å°æº–æç¤º -->
    <div id="alignHint">å°‡ Marker å°æº–æ­¤æ¡†å…§</div>
    
    <!-- èª¿è©¦ä¿¡æ¯ -->
    <div id="debugInfo"></div>

    <!-- AR å ´æ™¯ - ä½¿ç”¨æœ€åŸºç¤çš„é…ç½® -->
    <a-scene 
        id="arScene"
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 4x4; cameraParametersUrl: https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/data/camera_para.dat;">
        
        <!-- ç›¸æ©Ÿ -->
        <a-camera></a-camera>

        <!-- Marker 6 - é³¥å«è² -->
        <a-marker 
            id="marker6"
            type="barcode" 
            value="6"
            raycaster="objects: .clickable"
            emitevents="true"
            cursor="fuse: false; rayOrigin: mouse;">
            
            <!-- è¦–è¦ºå›é¥‹ï¼šåŠé€æ˜æ–¹å¡Š -->
            <a-box 
                position="0 0.5 0" 
                rotation="0 0 0" 
                scale="0.5 0.5 0.5"
                material="color: #4CAF50; opacity: 0.5; transparent: true"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
            </a-box>
            
            <!-- æ–‡å­—æ¨™ç±¤ -->
            <a-text 
                value="Bird Sound" 
                position="0 1 0" 
                align="center"
                color="#4CAF50"
                scale="0.5 0.5 0.5">
            </a-text>
        </a-marker>

        <!-- Marker 12 - æ²³æµè² -->
        <a-marker 
            id="marker12"
            type="barcode" 
            value="12"
            emitevents="true">
            
            <!-- è¦–è¦ºå›é¥‹ï¼šåŠé€æ˜æ–¹å¡Š -->
            <a-box 
                position="0 0.5 0" 
                rotation="0 0 0" 
                scale="0.5 0.5 0.5"
                material="color: #2196F3; opacity: 0.5; transparent: true"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
            </a-box>
            
            <!-- æ–‡å­—æ¨™ç±¤ -->
            <a-text 
                value="River Sound" 
                position="0 1 0" 
                align="center"
                color="#2196F3"
                scale="0.5 0.5 0.5">
            </a-text>
        </a-marker>

        <!-- å…‰æº -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="0 1 0" intensity="0.5"></a-light>
    </a-scene>

    <script>
        // åˆå§‹åŒ– Tone.js
        let birdPlayer = null;
        let riverPlayer = null;
        let isInitialized = false;
        let currentMarker = null;
        let fadeInTime = 2; // æ·¡å…¥æ™‚é–“ï¼ˆç§’ï¼‰
        let fadeOutTime = 2; // æ·¡å‡ºæ™‚é–“ï¼ˆç§’ï¼‰

        // ç°¡åŒ–åˆå§‹åŒ–æª¢æŸ¥ - ä¸ä¾è³´ AR.js çµ„ä»¶è¨»å†Šç‹€æ…‹
        // AR.js å¯èƒ½åœ¨é‹è¡Œæ™‚æ‰å®Œå…¨åˆå§‹åŒ–

        // é–‹å§‹æŒ‰éˆ•é»æ“Šäº‹ä»¶ - æœ€ç°¡åŒ–ç‰ˆæœ¬ï¼Œè®“ AR.js è‡ªå·±è™•ç†
        document.getElementById('startButton').addEventListener('click', function() {
            // éš±è—é®ç½©å±¤
            document.getElementById('startOverlay').classList.add('hidden');
            initializeAudio();
            
            // ç­‰å¾…å ´æ™¯è¼‰å…¥
            const scene = document.querySelector('a-scene');
            
            // å ´æ™¯è¼‰å…¥å¾Œè¨­ç½®äº‹ä»¶
            if (scene.hasLoaded) {
                setupAfterSceneLoad();
            } else {
                scene.addEventListener('loaded', setupAfterSceneLoad, { once: true });
            }
        });
        
        // å ´æ™¯è¼‰å…¥å¾Œçš„è¨­ç½®
        function setupAfterSceneLoad() {
            console.log('Scene loaded, setting up...');
            
            // ç­‰å¾…ä¸€ä¸‹è®“ AR.js åˆå§‹åŒ–
            setTimeout(() => {
                // è¨­ç½® Marker äº‹ä»¶
                setupMarkerEvents();
                
                // å•Ÿå‹• AR æª¢æŸ¥
                startAR();
            }, 2000);
        }

        // æª¢æŸ¥ç›¸æ©Ÿæ˜¯å¦æ­£åœ¨é‹è¡Œï¼ˆæ›´åš´æ ¼çš„æª¢æŸ¥ï¼‰
        function isCameraRunning() {
            // æª¢æŸ¥æ‰€æœ‰è¦–é »å…ƒç´ 
            const videoElements = document.querySelectorAll('video');
            for (let video of videoElements) {
                // ç¢ºä¿è¦–é »ä¸åƒ…è¼‰å…¥ï¼Œé‚„è¦çœŸæ­£åœ¨æ’­æ”¾ä¸”ä¸æ˜¯æš«åœç‹€æ…‹
                if (video.readyState >= 2 && 
                    video.videoWidth > 0 && 
                    video.videoHeight > 0 &&
                    !video.paused) {
                    // æª¢æŸ¥è¦–é »æµæ˜¯å¦çœŸçš„åœ¨é‹è¡Œ
                    const stream = video.srcObject;
                    if (stream && stream.active) {
                        return true;
                    }
                    // å¦‚æœæ²’æœ‰ streamï¼Œè‡³å°‘æª¢æŸ¥è¦–é »å°ºå¯¸å’Œæ’­æ”¾ç‹€æ…‹
                    if (video.videoWidth > 0 && !video.paused) {
                        return true;
                    }
                }
            }
            
            // æª¢æŸ¥ AR.js çš„è¦–é »å…ƒç´ 
            const scene = document.querySelector('a-scene');
            if (scene && scene.systems && scene.systems.arjs) {
                const arContext = scene.systems.arjs.arContext;
                if (arContext && arContext._video) {
                    const video = arContext._video;
                    if (video.readyState >= 2 && 
                        video.videoWidth > 0 && 
                        video.videoHeight > 0 &&
                        !video.paused) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        function startAR() {
            const loadingStatus = document.getElementById('loadingStatus');
            
            loadingStatus.classList.add('show');
            loadingStatus.textContent = 'æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...';
            
            // ç°¡åŒ–æª¢æŸ¥ï¼šåªæª¢æŸ¥ç›¸æ©Ÿæ˜¯å¦åœ¨é‹è¡Œï¼Œä¸ä¾è³´ AR Context
            let checkCount = 0;
            const maxChecks = 30; // æœ€å¤šæª¢æŸ¥ 15 ç§’
            
            const checkInterval = setInterval(() => {
                checkCount++;
                
                // æª¢æŸ¥ç›¸æ©Ÿæ˜¯å¦åœ¨é‹è¡Œ
                if (isCameraRunning()) {
                    console.log('Camera is running, AR ready');
                    loadingStatus.textContent = 'AR å·²å°±ç·’ï¼';
                    clearInterval(checkInterval);
                    
                    setTimeout(() => {
                        loadingStatus.classList.remove('show');
                        updateScanStatus('ğŸ“· è«‹å°‡æ”åƒé ­å°æº– Marker 6 æˆ– Marker 12', 'scanning');
                        updateDebugInfo();
                        setInterval(updateDebugInfo, 1000);
                    }, 1500);
                    return;
                }
                
                // é¡¯ç¤ºé€²åº¦
                if (checkCount % 2 === 0) {
                    const seconds = Math.floor(checkCount * 0.5);
                    loadingStatus.textContent = `æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ... (${seconds}ç§’)`;
                }
                
                // è¶…æ™‚è™•ç†
                if (checkCount >= maxChecks) {
                    clearInterval(checkInterval);
                    console.log('Timeout reached');
                    
                    // å³ä½¿è¶…æ™‚ï¼Œä¹Ÿé¡¯ç¤ºå°±ç·’ï¼ˆAR.js å¯èƒ½å·²ç¶“åœ¨å¾Œå°é‹è¡Œï¼‰
                    loadingStatus.textContent = 'AR å·²å°±ç·’ï¼';
                    setTimeout(() => {
                        loadingStatus.classList.remove('show');
                        updateScanStatus('ğŸ“· è«‹å°‡æ”åƒé ­å°æº– Marker 6 æˆ– Marker 12', 'scanning');
                        updateDebugInfo();
                        setInterval(updateDebugInfo, 1000);
                    }, 1500);
                }
            }, 500);
        }

        // åˆå§‹åŒ–éŸ³è¨Š
        function initializeAudio() {
            if (isInitialized) return;
            
            // åˆå§‹åŒ– Tone.js ä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ç”¨æˆ¶äº¤äº’ï¼‰
            Tone.start().then(() => {
                console.log('Tone.js initialized');
                
                // ç²å–æ­£ç¢ºçš„éŸ³è¨Šæ–‡ä»¶è·¯å¾‘
                const getAudioPath = (filename) => {
                    // å¦‚æœæ˜¯ç›¸å°è·¯å¾‘ï¼Œç¢ºä¿å¾ç•¶å‰ HTML æ–‡ä»¶çš„ä½ç½®é–‹å§‹
                    const basePath = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                    return basePath + filename;
                };
                
                const birdPath = getAudioPath('bird.mp3');
                const riverPath = getAudioPath('river.mp3');
                
                console.log('Loading audio files:');
                console.log('Bird path:', birdPath);
                console.log('River path:', riverPath);
                
                // å‰µå»º bird.mp3 æ’­æ”¾å™¨ï¼ˆå¸¶æ·¡å…¥æ·¡å‡ºï¼‰
                birdPlayer = new Tone.Player({
                    url: birdPath,
                    loop: true,
                    volume: -100 // å¾éœéŸ³é–‹å§‹
                }).toDestination();
                
                // å‰µå»º river.mp3 æ’­æ”¾å™¨
                riverPlayer = new Tone.Player({
                    url: riverPath,
                    loop: true,
                    volume: -100 // å¾éœéŸ³é–‹å§‹
                }).toDestination();
                
                // é è¼‰éŸ³è¨Šï¼Œåˆ†åˆ¥è™•ç†æ¯å€‹æ–‡ä»¶çš„è¼‰å…¥
                let birdLoaded = false;
                let riverLoaded = false;
                
                const checkAllLoaded = () => {
                    if (birdLoaded && riverLoaded) {
                        console.log('All audio files loaded successfully');
                        isInitialized = true;
                        console.log('Audio initialized and ready');
                    }
                };
                
                birdPlayer.load()
                    .then(() => {
                        console.log('Bird audio loaded successfully');
                        birdLoaded = true;
                        checkAllLoaded();
                    })
                    .catch(err => {
                        console.error('Failed to load bird.mp3:', err);
                        console.error('Tried path:', birdPath);
                        birdLoaded = true; // æ¨™è¨˜ç‚ºå·²è™•ç†ï¼Œé¿å…é˜»å¡
                        checkAllLoaded();
                        // ä¸ç«‹å³é¡¯ç¤ºéŒ¯èª¤ï¼Œç­‰å…©å€‹æ–‡ä»¶éƒ½å˜—è©¦è¼‰å…¥å¾Œå†é¡¯ç¤º
                    });
                
                riverPlayer.load()
                    .then(() => {
                        console.log('River audio loaded successfully');
                        riverLoaded = true;
                        checkAllLoaded();
                    })
                    .catch(err => {
                        console.error('Failed to load river.mp3:', err);
                        console.error('Tried path:', riverPath);
                        riverLoaded = true; // æ¨™è¨˜ç‚ºå·²è™•ç†ï¼Œé¿å…é˜»å¡
                        checkAllLoaded();
                    });
                
                // ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œæª¢æŸ¥æ˜¯å¦è¼‰å…¥æˆåŠŸ
                setTimeout(() => {
                    if (!isInitialized) {
                        console.warn('Audio files may not have loaded. Checking...');
                        const birdReady = birdPlayer && birdPlayer.loaded !== false;
                        const riverReady = riverPlayer && riverPlayer.loaded !== false;
                        
                        if (!birdReady || !riverReady) {
                            const errorStatus = document.getElementById('errorStatus');
                            let errorMsg = 'âš ï¸ ç„¡æ³•è¼‰å…¥éŸ³è¨Šæ–‡ä»¶<br>';
                            errorMsg += 'è«‹ä½¿ç”¨ HTTP æœå‹™å™¨é‹è¡Œï¼ˆä¸è¦ç›´æ¥ç”¨ file:// æ‰“é–‹ï¼‰<br>';
                            errorMsg += 'è©³è¦‹æ§åˆ¶å°èªªæ˜';
                            
                            errorStatus.innerHTML = errorMsg;
                            errorStatus.classList.add('show');
                            
                            let consoleMsg = 'ç„¡æ³•è¼‰å…¥éŸ³è¨Šæ–‡ä»¶ã€‚\n\n';
                            consoleMsg += 'è«‹ç¢ºèªï¼š\n';
                            consoleMsg += '1. bird.mp3 å’Œ river.mp3 æ–‡ä»¶èˆ‡ index.html åœ¨åŒä¸€ç›®éŒ„\n';
                            consoleMsg += '2. ä½¿ç”¨ HTTP æœå‹™å™¨é‹è¡Œï¼ˆä¸è¦ç›´æ¥ç”¨ file:// æ‰“é–‹ï¼‰\n';
                            consoleMsg += '3. æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°çš„éŒ¯èª¤è¨Šæ¯\n\n';
                            consoleMsg += 'å»ºè­°ä½¿ç”¨æœ¬åœ°æœå‹™å™¨ï¼š\n';
                            consoleMsg += '- Python: python -m http.server 8000\n';
                            consoleMsg += '- Node.js: npx http-server\n';
                            consoleMsg += '- VS Code: ä½¿ç”¨ Live Server æ“´å±•\n';
                            consoleMsg += 'ç„¶å¾Œè¨ªå• http://localhost:8000';
                            
                            console.error('Audio loading failed:', {
                                birdReady: birdReady,
                                riverReady: riverReady,
                                birdPath: birdPath,
                                riverPath: riverPath
                            });
                            
                            console.error(consoleMsg);
                            
                            // å³ä½¿è¼‰å…¥å¤±æ•—ï¼Œä¹Ÿæ¨™è¨˜ç‚ºå·²åˆå§‹åŒ–ï¼Œå…è¨±ç¹¼çºŒä½¿ç”¨ï¼ˆå¯èƒ½åªæ˜¯è·¯å¾‘å•é¡Œï¼‰
                            isInitialized = true;
                            
                            // 10ç§’å¾Œè‡ªå‹•éš±è—éŒ¯èª¤æç¤º
                            setTimeout(() => {
                                errorStatus.classList.remove('show');
                            }, 10000);
                        } else {
                            isInitialized = true;
                            console.log('Audio initialized (delayed check)');
                        }
                    }
                }, 3000);
            }).catch(err => {
                console.error('Failed to initialize Tone.js:', err);
            });
        }

        // æ·¡å…¥æ’­æ”¾éŸ³è¨Š
        function fadeInPlay(player, targetVolume = 0.5) {
            if (!player || !isInitialized) {
                console.warn('Cannot play audio: player=', !!player, 'isInitialized=', isInitialized);
                return;
            }
            
            // æª¢æŸ¥éŸ³è¨Šæ˜¯å¦å·²è¼‰å…¥
            if (player.loaded === false) {
                console.warn('Audio not loaded yet, waiting...');
                player.load().then(() => {
                    console.log('Audio loaded, starting playback');
                    player.volume.value = -100; // å¾éœéŸ³é–‹å§‹
                    player.start();
                    // æ·¡å…¥
                    player.volume.rampTo(Tone.gainToDb(targetVolume), fadeInTime);
                }).catch(err => {
                    console.error('Failed to load audio:', err);
                });
                return;
            }
            
            console.log('Starting audio playback with fade in');
            console.log('Player state:', player.state);
            console.log('Player loaded:', player.loaded);
            
            // å¦‚æœå·²ç¶“åœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢
            if (player.state === 'started') {
                player.stop();
            }
            
            player.volume.value = -100; // å¾éœéŸ³é–‹å§‹ï¼ˆdBï¼‰
            player.start();
            
            // æ·¡å…¥ï¼ˆTone.js ä½¿ç”¨ dB å€¼ï¼ŒtargetVolume æ˜¯ 0-1 çš„å¢ç›Šå€¼ï¼‰
            const targetDb = Tone.gainToDb(targetVolume);
            console.log('Fading in to', targetDb, 'dB (gain:', targetVolume, ')');
            player.volume.rampTo(targetDb, fadeInTime);
        }

        // æ·¡å‡ºåœæ­¢éŸ³è¨Š
        function fadeOutStop(player) {
            if (!player || !isInitialized) return;
            
            console.log('Stopping audio with fade out');
            // æ·¡å‡ºï¼ˆTone.js ä½¿ç”¨ dB å€¼ï¼‰
            player.volume.rampTo(-100, fadeOutTime);
            
            // æ·¡å‡ºå®Œæˆå¾Œåœæ­¢
            setTimeout(() => {
                if (player && player.state === 'started') {
                    player.stop();
                    console.log('Audio stopped');
                }
            }, fadeOutTime * 1000);
        }

        // åœæ­¢æ‰€æœ‰éŸ³è¨Š
        function stopAllAudio() {
            console.log('Stopping all audio');
            if (birdPlayer && birdPlayer.state === 'started') {
                console.log('Stopping bird player');
                fadeOutStop(birdPlayer);
            }
            if (riverPlayer && riverPlayer.state === 'started') {
                console.log('Stopping river player');
                fadeOutStop(riverPlayer);
            }
        }

        // æ›´æ–°æƒæç‹€æ…‹é¡¯ç¤º
        function updateScanStatus(message, type = 'scanning') {
            const scanStatus = document.getElementById('scanStatus');
            const scanFrame = document.getElementById('scanFrame');
            const alignHint = document.getElementById('alignHint');
            
            scanStatus.textContent = message;
            scanStatus.className = 'show ' + type;
            
            // æ§åˆ¶æƒææ¡†é¡¯ç¤º
            if (type === 'scanning') {
                scanFrame.classList.add('show', 'detecting');
                scanFrame.classList.remove('detected');
                alignHint.classList.add('show');
                alignHint.textContent = 'å°‡ Marker å°æº–æ­¤æ¡†å…§';
            } else if (type === 'detected') {
                scanFrame.classList.add('show', 'detected');
                scanFrame.classList.remove('detecting');
                alignHint.classList.add('show');
                alignHint.textContent = 'âœ… æª¢æ¸¬æˆåŠŸï¼';
                // 3ç§’å¾Œæ¢å¾©æƒæç‹€æ…‹
                setTimeout(() => {
                    if (scanFrame.classList.contains('detected')) {
                        scanFrame.classList.remove('detected');
                        scanFrame.classList.add('detecting');
                        alignHint.textContent = 'å°‡ Marker å°æº–æ­¤æ¡†å…§';
                    }
                }, 3000);
            }
            
            // é¡¯ç¤ºä½¿ç”¨èªªæ˜ï¼ˆåªåœ¨é–‹å§‹æƒææ™‚é¡¯ç¤ºä¸€æ¬¡ï¼‰
            const instructions = document.getElementById('instructions');
            if (type === 'scanning' && !instructions.classList.contains('shown')) {
                instructions.classList.add('show', 'shown');
                // 10ç§’å¾Œè‡ªå‹•éš±è—èªªæ˜
                setTimeout(() => {
                    instructions.classList.remove('show');
                }, 10000);
            }
        }

        // æ›´æ–°èª¿è©¦ä¿¡æ¯
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const scene = document.querySelector('a-scene');
            let info = '<div class="success">âœ“ AR.js èª¿è©¦ä¿¡æ¯</div><br>';
            
            // æª¢æŸ¥ AR.js ç³»çµ±
            if (scene && scene.systems && scene.systems.arjs) {
                const arSystem = scene.systems.arjs;
                
                info += '<div class="success">âœ“ AR.js ç³»çµ±å·²è¼‰å…¥</div><br>';
                
                // å˜—è©¦å¤šç¨®æ–¹å¼ç²å– arContext
                let arContext = arSystem.arContext;
                if (!arContext) {
                    // å˜—è©¦å…¶ä»–å¯èƒ½çš„å±¬æ€§å
                    arContext = arSystem._arContext || arSystem.context;
                }
                
                // æª¢æŸ¥ç›¸æ©Ÿæ˜¯å¦åœ¨é‹è¡Œï¼ˆä¸ä¾è³´ AR Contextï¼‰
                const cameraRunning = isCameraRunning();
                if (cameraRunning) {
                    info += '<div class="success">âœ“ ç›¸æ©Ÿæ­£åœ¨é‹è¡Œ</div><br>';
                } else {
                    info += '<div class="warning">âš  ç›¸æ©Ÿæœªé‹è¡Œ</div><br>';
                }
                
                if (arContext) {
                    info += '<div class="success">âœ“ AR Context å·²åˆå§‹åŒ–</div><br>';
                    
                    // æª¢æŸ¥è¦–é »
                    if (arContext._video) {
                        const video = arContext._video;
                        info += `<div class="success">âœ“ è¦–é »: ${video.videoWidth}x${video.videoHeight}</div><br>`;
                    } else {
                        info += '<div class="warning">âš  è¦–é »æœªåˆå§‹åŒ–</div><br>';
                    }
                    
                    // æª¢æŸ¥æª¢æ¸¬å™¨
                    if (arContext._arDetector) {
                        info += '<div class="success">âœ“ æª¢æ¸¬å™¨å·²åˆå§‹åŒ–</div><br>';
                    } else {
                        info += '<div class="warning">âš  æª¢æ¸¬å™¨æœªåˆå§‹åŒ–</div><br>';
                    }
                    
                    // æª¢æŸ¥æª¢æ¸¬åˆ°çš„ marker æ•¸é‡ï¼ˆå˜—è©¦å¤šç¨®æ–¹å¼ï¼‰
                    let markerCount = 0;
                    let detectedMarkers = [];
                    
                    // æ–¹æ³•1: æª¢æŸ¥ _arDetector.markers
                    if (arContext._arDetector && arContext._arDetector.markers) {
                        markerCount = arContext._arDetector.markers.length;
                        detectedMarkers = arContext._arDetector.markers;
                    }
                    // æ–¹æ³•2: æª¢æŸ¥ arDetector
                    else if (arContext.arDetector && arContext.arDetector.markers) {
                        markerCount = arContext.arDetector.markers.length;
                        detectedMarkers = arContext.arDetector.markers;
                    }
                    // æ–¹æ³•3: æª¢æŸ¥ _markers
                    else if (arContext._markers) {
                        markerCount = arContext._markers.length;
                        detectedMarkers = arContext._markers;
                    }
                    
                    info += `<div>æª¢æ¸¬åˆ°çš„ Marker: <strong>${markerCount}</strong></div><br>`;
                    
                    if (markerCount > 0) {
                        detectedMarkers.forEach((marker, index) => {
                            const markerId = marker.id || marker.markerId || 'æœªçŸ¥';
                            info += `<div class="success">âœ“ Marker ${index + 1}: ID=${markerId}</div><br>`;
                        });
                    } else {
                        info += '<div class="warning">âš  æœªæª¢æ¸¬åˆ°ä»»ä½• Marker</div><br>';
                        info += '<div style="font-size:10px;">æç¤º: ç¢ºä¿ Marker åœ¨ç•«é¢ä¸­ï¼Œå…‰ç·šå……è¶³</div><br>';
                    }
                    
                    // æª¢æŸ¥ Marker å…ƒç´ çš„å¯è¦‹æ€§
                    const marker6El = document.getElementById('marker6');
                    const marker12El = document.getElementById('marker12');
                    if (marker6El) {
                        const marker6Visible = marker6El.object3D.visible;
                        info += `<div>Marker 6 å¯è¦‹: ${marker6Visible ? 'âœ“' : 'âœ—'}</div><br>`;
                    }
                    if (marker12El) {
                        const marker12Visible = marker12El.object3D.visible;
                        info += `<div>Marker 12 å¯è¦‹: ${marker12Visible ? 'âœ“' : 'âœ—'}</div><br>`;
                    }
                } else {
                    info += '<div class="warning">âš  AR Context æœªåˆå§‹åŒ–</div><br>';
                    
                    // å³ä½¿ Context æœªåˆå§‹åŒ–ï¼Œå¦‚æœç›¸æ©Ÿåœ¨é‹è¡Œï¼ŒAR å¯èƒ½ä»ç„¶å¯ç”¨
                    if (cameraRunning) {
                        info += '<div class="success" style="font-size:11px;">âœ“ ä½†ç›¸æ©Ÿåœ¨é‹è¡Œï¼ŒAR å¯èƒ½ä»å¯ç”¨</div><br>';
                        info += '<div style="font-size:10px;">æç¤º: å˜—è©¦å°æº– Markerï¼Œå³ä½¿é¡¯ç¤ºæœªåˆå§‹åŒ–ä¹Ÿå¯èƒ½èƒ½æª¢æ¸¬</div><br>';
                    } else {
                        info += '<div style="font-size:10px;">æç¤º: è«‹ç¢ºä¿å·²é»æ“Š"é»æ“Šé–‹å§‹"ä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™</div><br>';
                    }
                    
                    // å˜—è©¦æª¢æŸ¥æ˜¯å¦å¯ä»¥æ‰‹å‹•åˆå§‹åŒ–
                    if (arSystem && typeof arSystem.init === 'function') {
                        info += '<div style="font-size:10px;">å˜—è©¦æ‰‹å‹•åˆå§‹åŒ–...</div><br>';
                        try {
                            arSystem.init();
                        } catch (e) {
                            info += `<div class="error" style="font-size:10px;">åˆå§‹åŒ–å¤±æ•—: ${e.message}</div><br>`;
                        }
                    }
                }
            } else {
                info += '<div class="error">âœ— AR.js ç³»çµ±æœªæ‰¾åˆ°</div><br>';
            }
            
            // æª¢æŸ¥ Marker å…ƒç´ 
            const marker6 = document.getElementById('marker6');
            const marker12 = document.getElementById('marker12');
            if (marker6 && marker12) {
                info += '<div class="success">âœ“ Marker å…ƒç´ å·²è¼‰å…¥</div><br>';
            } else {
                info += '<div class="error">âœ— Marker å…ƒç´ æœªæ‰¾åˆ°</div><br>';
            }
            
            debugInfo.innerHTML = info;
            debugInfo.classList.add('show');
        }

        // è¨­ç½® Marker æª¢æ¸¬äº‹ä»¶ï¼ˆåœ¨å ´æ™¯è¼‰å…¥å¾Œï¼‰
        function setupMarkerEvents() {
            const marker6 = document.getElementById('marker6');
            const marker12 = document.getElementById('marker12');
            
            if (!marker6 || !marker12) {
                console.warn('Markers not found, retrying...');
                setTimeout(setupMarkerEvents, 500);
                return;
            }
            
            console.log('Setting up marker events');
            
            // é¡¯ç¤ºèª¿è©¦ä¿¡æ¯
            updateDebugInfo();
            // æ¯ 1 ç§’æ›´æ–°ä¸€æ¬¡èª¿è©¦ä¿¡æ¯
            setInterval(updateDebugInfo, 1000);
            
            // é¡¯ç¤ºæƒææç¤º
            updateScanStatus('ğŸ“· è«‹å°‡æ”åƒé ­å°æº– Marker 6 æˆ– Marker 12', 'scanning');
            
            // å³ä½¿ AR Context æœªåˆå§‹åŒ–ï¼Œä¹Ÿå˜—è©¦è¨­ç½®äº‹ä»¶ç›£è½å™¨
            // AR.js çš„ Marker äº‹ä»¶å¯èƒ½ä»ç„¶èƒ½æ­£å¸¸å·¥ä½œ
            console.log('Marker events will work even if AR Context shows uninitialized');
            
            // Marker 6 äº‹ä»¶
            marker6.addEventListener('markerFound', function() {
                console.log('=== Marker 6 detected! ===');
                console.log('Current marker:', currentMarker);
                console.log('Bird player:', birdPlayer);
                console.log('Audio initialized:', isInitialized);
                
                updateScanStatus('âœ… Marker 6 å·²æª¢æ¸¬åˆ°ï¼æ’­æ”¾é³¥å«è² ğŸ¦', 'detected');
                
                if (currentMarker !== 'marker6') {
                    console.log('Playing bird sound');
                    stopAllAudio();
                    currentMarker = 'marker6';
                    // ç­‰å¾…ä¸€ä¸‹ç¢ºä¿å‰ä¸€å€‹éŸ³è¨Šå·²åœæ­¢
                    setTimeout(() => {
                        fadeInPlay(birdPlayer, 0.5);
                    }, 100);
                } else {
                    console.log('Marker 6 already active, skipping');
                }
            });

            marker6.addEventListener('markerLost', function() {
                console.log('Marker 6 lost');
                updateScanStatus('ğŸ“· è«‹å°‡æ”åƒé ­å°æº– Marker 6 æˆ– Marker 12', 'scanning');
                if (currentMarker === 'marker6') {
                    fadeOutStop(birdPlayer);
                    currentMarker = null;
                }
            });

            // Marker 12 äº‹ä»¶
            marker12.addEventListener('markerFound', function() {
                console.log('=== Marker 12 detected! ===');
                console.log('Current marker:', currentMarker);
                console.log('River player:', riverPlayer);
                console.log('Audio initialized:', isInitialized);
                
                updateScanStatus('âœ… Marker 12 å·²æª¢æ¸¬åˆ°ï¼æ’­æ”¾æ²³æµè² ğŸŒŠ', 'detected');
                
                if (currentMarker !== 'marker12') {
                    console.log('Playing river sound');
                    stopAllAudio();
                    currentMarker = 'marker12';
                    // ç­‰å¾…ä¸€ä¸‹ç¢ºä¿å‰ä¸€å€‹éŸ³è¨Šå·²åœæ­¢
                    setTimeout(() => {
                        fadeInPlay(riverPlayer, 0.5);
                    }, 100);
                } else {
                    console.log('Marker 12 already active, skipping');
                }
            });

            marker12.addEventListener('markerLost', function() {
                console.log('Marker 12 lost');
                updateScanStatus('ğŸ“· è«‹å°‡æ”åƒé ­å°æº– Marker 6 æˆ– Marker 12', 'scanning');
                if (currentMarker === 'marker12') {
                    fadeOutStop(riverPlayer);
                    currentMarker = null;
                }
            });
            
            console.log('Marker events set up successfully');
        }

        // ç­‰å¾…å ´æ™¯è¼‰å…¥å¾Œè¨­ç½®äº‹ä»¶
        const scene = document.querySelector('a-scene');
        if (scene.hasLoaded) {
            setupMarkerEvents();
        } else {
            scene.addEventListener('loaded', function() {
                console.log('Scene loaded, setting up marker events');
                setupMarkerEvents();
            });
        }

        // é é¢å¸è¼‰æ™‚æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopAllAudio();
            if (birdPlayer) birdPlayer.dispose();
            if (riverPlayer) riverPlayer.dispose();
        });
    </script>
</body>
</html>